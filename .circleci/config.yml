version: 2

jobs:
  install_dependencies:
    docker:
      - image: circleci/node:10
        environment:
          TS_NODE_PROJECT: e2e/tsconfig.json
    steps:
      - checkout
      - restore_cache:
          keys:
          - npm-dependencies-{{ checksum "package-lock.json" }}
          - npm-dependencies-
      - run:
          name: "Install node dependencies"
          command: npm ci
      - save_cache:
          name: Caching node_modules
          key: npm-dependencies-{{ checksum "package-lock.json" }}
          paths:
            - node_modules
  unit_tests:
    docker:
      - image: circleci/node:10
    steps:
      - checkout
      - restore_cache:
          name: Restoring node_modules
          key: npm-dependencies-{{ checksum "package-lock.json" }}
      - run:
          name: "Jest Test Suite"
          command: npm run test:ci -- --reporters=default --reporters=jest-junit
          environment:
            JEST_JUNIT_OUTPUT_DIR: "reports/junit"
            JEST_JUNIT_OUTPUT_NAME: "jest-test-results.xml"
      - store_test_results:
          path: reports
      - store_artifacts:
          name: "Uploading JUnit artifacts"
          path: reports/junit
      - store_artifacts:
          name: "Uploading code coverage artifacts"
          path: coverage
  eslint:
    docker:
      - image: circleci/node:10
    steps:
      - checkout
      - restore_cache:
          name: Restoring node_modules
          key: npm-dependencies-{{ checksum "package-lock.json" }}
      - run:
          name: "Run ESlint"
          command: ./node_modules/.bin/eslint --format junit -o reports/junit/js-lint-results.xml --ext=ts,tsx src/**/*
          environment:
            JEST_JUNIT_OUTPUT_DIR: "reports/junit"
            JEST_JUNIT_OUTPUT_NAME: "jest-test-results.xml"
      - store_test_results:
          path: reports
      - store_artifacts:
          name: "Uploading JUnit artifacts"
          path: reports/junit
  e2e:
    docker:
      - image: circleci/node:jessie-browsers

    steps:
      - checkout
      - run:
          name: Make log dir for selenium
          command: mkdir selenium-logs

      - run:
          name: Download Selenium
          command: curl -O http://selenium-release.storage.googleapis.com/3.5/selenium-server-standalone-3.5.3.jar

      - run:
          name: Start Selenium
          command: java -jar selenium-server-standalone-3.5.3.jar -log selenium-logs/selenium.log
          background: true

      - restore_cache:
          name: Restoring node_modules
          key: npm-dependencies-{{ checksum "package-lock.json" }}

      - run:
          name: Host website locally
          command: npm run serve
          background: true

      - run: npm run e2e
      - run: npm run e2e-report

      - store_artifacts:
          name: Store test artifacts - json, html
          path: e2e/reporting

      - store_artifacts:
          name: Store selenium logs
          path: selenium-logs

workflows:
  version: 2
  ci:
    jobs:
      - install_dependencies
      - eslint:
          requires:
            - install_dependencies
      - unit_tests:
          requires:
            - install_dependencies
      - e2e:
          requires:
              - unit_tests
              - eslint
